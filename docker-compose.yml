services:
  kb-api:
    image: ${ACR_LOGIN_SERVER}/${ACR_REPOSITORY}:${IMAGE_TAG:-latest}
    container_name: kb-api
    restart: unless-stopped
    ports:
      - "${HOST_PORT:-8000}:8000"

    environment:
      # Secrets / required runtime config
      # PostgreSQL connection (Azure style - from Doppler)
      POSTGRES_HOST: ${POSTGRES_HOST}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}

      # Legacy DATABASE_URL (kept for backward compatibility)
      DATABASE_URL: ${DATABASE_URL}
      PGVECTOR: ${PGVECTOR:-true}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      TAVILY_API_KEY: ${TAVILY_API_KEY}
      BRAVE_API_KEY: ${BRAVE_API_KEY}
      SENTRY_DSN: ${SENTRY_DSN}

      # Defaults
      SENTRY_ENVIRONMENT: ${SENTRY_ENVIRONMENT:-production}
      USE_HYBRID_SEARCH: ${USE_HYBRID_SEARCH:-true}
      USE_RERANKING: ${USE_RERANKING:-true}
      WEB_FALLBACK_ENABLED: ${WEB_FALLBACK_ENABLED:-true}
      TOP_K_DEFAULT: ${TOP_K_DEFAULT:-10}
      MAX_CONTEXT_LENGTH: ${MAX_CONTEXT_LENGTH:-4000}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - kb-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  kb-network:
    driver: bridge
