services:
  kb-api:
    image: ${ACR_LOGIN_SERVER}/${ACR_REPOSITORY}:${IMAGE_TAG:-latest}
    container_name: kb-api
    restart: unless-stopped
    ports:
      - "${PORT:-8000}:8000"
    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL}
      - PGVECTOR=${PGVECTOR:-true}

      # LLM
      - GEMINI_API_KEY=${GEMINI_API_KEY}

      # Web Search
      - TAVILY_API_KEY=${TAVILY_API_KEY}
      - BRAVE_API_KEY=${BRAVE_API_KEY}

      # Observability
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-production}

      # Feature Flags
      - USE_HYBRID_SEARCH=${USE_HYBRID_SEARCH:-true}
      - USE_RERANKING=${USE_RERANKING:-true}
      - WEB_FALLBACK_ENABLED=${WEB_FALLBACK_ENABLED:-true}

      # Performance
      - TOP_K_DEFAULT=${TOP_K_DEFAULT:-10}
      - MAX_CONTEXT_LENGTH=${MAX_CONTEXT_LENGTH:-4000}

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - kb-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  kb-network:
    driver: bridge
