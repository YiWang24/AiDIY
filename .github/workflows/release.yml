name: Release

on:
  push:
    branches: [main]
    tags: ['v*']

permissions:
  contents: read

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e kb
          pip install ruff pytest-cov
      - name: Lint
        run: |
          ruff check kb
          ruff format --check kb
      - name: Tests with coverage
        run: |
          pytest kb/tests --cov=kb --cov-report=xml

  build_and_push:
    runs-on: ubuntu-latest
    needs: release_checks
    steps:
      - uses: actions/checkout@v4
      - name: Compute image tag
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "IMAGE_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=main" >> $GITHUB_ENV
          fi
      - name: Log in to ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.ACR_REPOSITORY }}:${{ github.sha }}
            ${{ secrets.ACR_LOGIN_SERVER }}/${{ secrets.ACR_REPOSITORY }}:${{ env.IMAGE_TAG }}

  sentry_release:
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - uses: actions/checkout@v4
      - name: Compute release version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "RELEASE_VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV
          else
            echo "RELEASE_VERSION=${GITHUB_SHA}" >> $GITHUB_ENV
          fi
      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
        with:
          environment: production
          version: ${{ env.RELEASE_VERSION }}

  deploy_vps:
    runs-on: ubuntu-latest
    needs: sentry_release
    steps:
      - name: Deploy over SSH
        env:
          DEPLOY_SSH_HOST: ${{ secrets.DEPLOY_SSH_HOST }}
          DEPLOY_SSH_USER: ${{ secrets.DEPLOY_SSH_USER }}
          DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
          DEPLOY_SSH_PORT: ${{ secrets.DEPLOY_SSH_PORT }}
          ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
          ACR_REPOSITORY: ${{ secrets.ACR_REPOSITORY }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
          IMAGE_TAG: ${{ github.sha }}
          DEPLOY_WORKDIR: ${{ secrets.DEPLOY_WORKDIR }}
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
          DOPPLER_PROJECT: ${{ secrets.DOPPLER_PROJECT }}
          DOPPLER_CONFIG: ${{ secrets.DOPPLER_CONFIG }}
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${DEPLOY_SSH_PORT:-22} "$DEPLOY_SSH_HOST" >> ~/.ssh/known_hosts

          ssh -p ${DEPLOY_SSH_PORT:-22} "$DEPLOY_SSH_USER@$DEPLOY_SSH_HOST" <<SSH
          set -euo pipefail

          export ACR_LOGIN_SERVER="$ACR_LOGIN_SERVER"
          export ACR_REPOSITORY="$ACR_REPOSITORY"
          export IMAGE_TAG="$IMAGE_TAG"
          export DOPPLER_TOKEN="$DOPPLER_TOKEN"
          export DOPPLER_PROJECT="$DOPPLER_PROJECT"
          export DOPPLER_CONFIG="$DOPPLER_CONFIG"
          export HEALTHCHECK_URL="$HEALTHCHECK_URL"

          docker login "$ACR_LOGIN_SERVER" -u "$ACR_USERNAME" -p "$ACR_PASSWORD"
          docker pull "$ACR_LOGIN_SERVER/$ACR_REPOSITORY:$IMAGE_TAG"

          cd "$DEPLOY_WORKDIR"

          # Example using docker compose. Adjust to your process manager.
          IMAGE_TAG="$IMAGE_TAG" doppler run --project "$DOPPLER_PROJECT" --config "$DOPPLER_CONFIG" -- \
            docker compose up -d

          # Basic health check
          if [ -n "${HEALTHCHECK_URL:-}" ]; then
            curl -fsS "$HEALTHCHECK_URL"
          fi
          SSH
